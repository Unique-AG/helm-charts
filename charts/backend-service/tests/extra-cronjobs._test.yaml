# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test Extra CronJobs
templates:
  - extra-cronjobs.yaml
release:
  name: ecj
tests:
  - it: When given an extra CronJob, renders the CronJob with the correct values
    values:
      - ../ci/extra-cronjobs-values.yaml
    template: extra-cronjobs.yaml
    documentSelector:
      path: metadata.name
      value: ecj-foo
    asserts:
      - isKind:
          of: CronJob
      - equal:
          path: spec.concurrencyPolicy
          value: Forbid
      - equal:
          path: spec.jobTemplate.spec.template.spec.restartPolicy
          value: Never
      - exists:
          path: spec.jobTemplate.spec.template.spec.containers[?(@.name == "foo")]
      - exists:
          path: spec.jobTemplate.spec.template.spec.containers[?(@.name == "foo")].env[?(@.name == "DATABASE_URL")]
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[?(@.name == "foo")].env[?(@.name == "BAZ")].value
          value: qux
      - exists:
          path: spec.jobTemplate.spec.template.spec.volumes[?(@.name == "ecj-ut-ecj-service")]
      - equal:
          path: spec.jobTemplate.spec.template.spec.volumes[?(@.name == "ecj-ut-ecj-service")].csi.driver
          value: secrets-store.csi.k8s.io
