suite: Test Multiple Hooks
templates:
  - hooks/hooks-env.yaml
  - hooks/hooks.yaml
  - hooks/serviceaccount.yaml
  - hooks/secretproviderclass.yaml
release:
  name: ut
tests:
  - it: When multiple hooks are enabled, should create separate Jobs
    set:
      image.tag: pinned-version
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      hooks.migration.backoffLimit: 2
      hooks.migration.helm:
        hook: pre-install
        weight: "10"
        deletePolicy: before-hook-creation
      hooks.seed.enabled: true
      hooks.seed.command: npm run seed
      hooks.seed.backoffLimit: 1
      hooks.seed.helm:
        hook: post-upgrade
        weight: "11"
        deletePolicy: before-hook-creation
    template: hooks/hooks.yaml
    asserts:
      - hasDocuments:
          count: 2

      # Check migration job
      - isKind:
          of: Job
        documentIndex: 0
      - equal:
          path: metadata.name
          value: ut-migration
        documentIndex: 0
      - equal:
          path: spec.backoffLimit
          value: 2
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].name
          value: db-migration
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].command[2]
          value: npm run migrate
        documentIndex: 0
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install
        documentIndex: 0
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "10"
        documentIndex: 0

      # Check seed job
      - isKind:
          of: Job
        documentIndex: 1
      - equal:
          path: metadata.name
          value: ut-seed
        documentIndex: 1
      - equal:
          path: spec.backoffLimit
          value: 1
        documentIndex: 1
      - equal:
          path: spec.template.spec.containers[0].name
          value: seed
        documentIndex: 1
      - equal:
          path: spec.template.spec.containers[0].command[2]
          value: npm run seed
        documentIndex: 1
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: post-upgrade
        documentIndex: 1
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "11"
        documentIndex: 1

  - it: When multiple hooks are enabled, should create only one shared ConfigMap
    set:
      image.tag: pinned-version
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      hooks.seed.enabled: true
      hooks.seed.command: npm run seed
      inlineEnv:
        DATABASE_URL: postgres://localhost
        LOG_LEVEL: info
    template: hooks/hooks-env.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: ut-hooks-env
      - equal:
          path: data.VERSION
          value: pinned-version
      - equal:
          path: data.DATABASE_URL
          value: postgres://localhost
      - equal:
          path: data.LOG_LEVEL
          value: info

  - it: When multiple hooks are enabled, both Jobs should reference the shared ConfigMap
    set:
      image.tag: pinned-version
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      hooks.seed.enabled: true
      hooks.seed.command: npm run seed
    template: hooks/hooks.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].envFrom[0].configMapRef.name
          value: ut-hooks-env
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].envFrom[0].configMapRef.name
          value: ut-hooks-env
        documentIndex: 1

  - it: When multiple hooks are enabled with serviceAccount, should create only one shared ServiceAccount
    set:
      image.tag: pinned-version
      serviceAccount.enabled: true
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      hooks.seed.enabled: true
      hooks.seed.command: npm run seed
    template: hooks/serviceaccount.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: ut-hooks

  - it: When multiple hooks are enabled, both Jobs should reference the shared ServiceAccount
    set:
      image.tag: pinned-version
      serviceAccount.enabled: true
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      hooks.seed.enabled: true
      hooks.seed.command: npm run seed
    template: hooks/hooks.yaml
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: ut-hooks
        documentIndex: 0
      - equal:
          path: spec.template.spec.serviceAccountName
          value: ut-hooks
        documentIndex: 1

  - it: When multiple hooks are enabled with secretProvider, should create only one shared SecretProviderClass per vault
    set:
      image.tag: pinned-version
      secretProvider.tenantId: 99330c76-81xxxx
      secretProvider.userAssignedIdentityID: test-identity-id
      secretProvider.vaults.qa-app-common.AMQP_URL: RABBITMQ-ORANGE-WOLF-URL
      secretProvider.vaults.qa-app-common.DB_PASSWORD: DATABASE-PASSWORD
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      hooks.seed.enabled: true
      hooks.seed.command: npm run seed
    template: hooks/secretproviderclass.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: SecretProviderClass
      - equal:
          path: metadata.name
          value: ut-qa-app-common-hooks
      - equal:
          path: spec.secretObjects[0].secretName
          value: ut-qa-app-common-hooks

  - it: When multiple hooks are enabled with secretProvider, both Jobs should reference the shared SecretProviderClass
    set:
      image.tag: pinned-version
      secretProvider.tenantId: 99330c76-81xxxx
      secretProvider.userAssignedIdentityID: test-identity-id
      secretProvider.vaults.qa-app-common.AMQP_URL: RABBITMQ-ORANGE-WOLF-URL
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      hooks.seed.enabled: true
      hooks.seed.command: npm run seed
    template: hooks/hooks.yaml
    asserts:
      # Check migration job references shared SecretProviderClass
      - equal:
          path: spec.template.spec.volumes[0].csi.volumeAttributes.secretProviderClass
          value: ut-qa-app-common-hooks
        documentIndex: 0
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: ut-qa-app-common-hooks
        documentIndex: 0

      # Check seed job references shared SecretProviderClass
      - equal:
          path: spec.template.spec.volumes[0].csi.volumeAttributes.secretProviderClass
          value: ut-qa-app-common-hooks
        documentIndex: 1
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: ut-qa-app-common-hooks
        documentIndex: 1

  - it: When only one hook is enabled, should still create shared resources with correct naming
    set:
      image.tag: pinned-version
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      hooks.seed.enabled: false
    template: hooks/hooks-env.yaml
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: ut-hooks-env

  - it: When given per-hook env, renders them in the env section
    set:
      image.tag: pinned-version
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      hooks.migration.env:
        HOOK_VAR: hook-value
    template: hooks/hooks.yaml
    asserts:
      - isKind:
          of: Job
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: HOOK_VAR
            value: hook-value

  - it: When given per-hook envVars, renders them after global envVars
    set:
      image.tag: pinned-version
      hooks.migration.enabled: true
      hooks.migration.command: npm run migrate
      envVars:
        - name: GLOBAL_VAR
          value: global-value
      hooks.migration.envVars:
        - name: LOCAL_VAR
          value: local-value
    template: hooks/hooks.yaml
    asserts:
      - isKind:
          of: Job
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GLOBAL_VAR
            value: global-value
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOCAL_VAR
            value: local-value
