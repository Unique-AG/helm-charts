suite: Regression Test Migration
templates:
  - hooks/migration.yaml
release:
  name: ut
tests:
  - it: When given a secretsProvider, should always render volumeMounts and volumes for them
    set:
      image.tag: pinned-version
      secretsProvider.enabled: true
      secretsProvider.azure.tenantId: 99330c76-81xxxx
      secretsProvider.azure.workloadIdentity.clientId: test-client-id
      secretsProvider.azure.keyVaults:
        - name: qa-app-common
          secrets:
            - name: AMQP_URL
              key: RABBITMQ-ORANGE-WOLF-URL
      hooks.migration.enabled: true
    template: hooks/migration.yaml
    asserts:
      - isKind:
          of: Job

      # Check if the volumes array exists in the template
      - isNotNullOrEmpty:
          path: spec.template.spec.volumes

      # Check if the specific volume exists
      - isNotNullOrEmpty:
          path: spec.template.spec.volumes[?(@.name == "secrets-store-qa-app-common")]

      # Check if the container array exists
      - isNotNullOrEmpty:
          path: spec.template.spec.containers

      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "db-migration")]

      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "db-migration")].volumeMounts

      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "db-migration")].volumeMounts[?(@.name == "secrets-store-qa-app-common")]

  - it: When given initContainers in migration
    set:
      image.tag: pinned-version
      hooks.migration.enabled: true
      hooks.migration.initContainers:
        - name: test-init
          image: busybox
          command:
            - "sh"
            - "-c"
            - "echo helloWorld"
    template: hooks/migration.yaml
    asserts:
      - isKind:
          of: Job
      - isNotNullOrEmpty:
          path: spec.template.spec.initContainers[0]
      - isNotNullOrEmpty:
          path: spec.template.spec.initContainers[?(@.name == "test-init")]

  - it: When given envVars, renders them to the JobSpec
    set:
      image.tag: pinned-version
      hooks.migration.enabled: true
      envVars:
        - name: NAME_OF_ENV
          valueFrom:
            secretKeyRef:
              name: my-secret
              key: ENV_VALUE
    template: hooks/migration.yaml
    asserts:
      - isKind:
          of: Job
      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "db-migration")].env[?(@.name == "NAME_OF_ENV")]
      - contains:
          path: spec.template.spec.containers[?(@.name == "db-migration")].env
          content:
            name: NAME_OF_ENV
            valueFrom:
              secretKeyRef:
                key: ENV_VALUE
                name: my-secret
          count: 1
          any: true
