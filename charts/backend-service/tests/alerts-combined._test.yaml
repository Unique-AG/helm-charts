# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Regression Test Combined Alerts
templates:
  - alerts/alerts-custom.yaml
  - alerts/alerts-argocd.yaml
  - alerts/alerts-kubernetes-application.yaml
  - alerts/alerts-kubernetes-resources.yaml
release:
  name: ut
tests:
  - it: should render all alert types when fully enabled
    set:
      prometheus.enabled: true
      prometheus.additionalAlerts:
        CustomAlert:
          expression: up == 0
          severity: warning
      prometheus.defaultAlerts.argocd.enabled: true
      prometheus.defaultAlerts.kubernetesApplication.enabled: true
      prometheus.defaultAlerts.kubernetesResources.enabled: true
    capabilities:
      apiVersions:
        - monitoring.coreos.com/v1
    asserts:
      - hasDocuments:
          count: 4
      - documentIndex: 0
        isKind:
          of: PrometheusRule
      - documentIndex: 0
        equal:
          path: metadata.labels.alertGroup
          value: custom

  - it: should render only enabled alert types
    set:
      prometheus.enabled: true
      prometheus.additionalAlerts:
        CustomAlert:
          expression: up == 0
      prometheus.defaultAlerts.argocd.enabled: true
      prometheus.defaultAlerts.kubernetesApplication.enabled: false
      prometheus.defaultAlerts.kubernetesResources.enabled: false
    capabilities:
      apiVersions:
        - monitoring.coreos.com/v1
    asserts:
      - hasDocuments:
          count: 2

  - it: should not render anything when prometheus is disabled
    set:
      prometheus.enabled: false
      prometheus.additionalAlerts:
        TestAlert:
          expression: up == 0
      prometheus.defaultAlerts.argocd.enabled: true
      prometheus.defaultAlerts.kubernetesApplication.enabled: true
      prometheus.defaultAlerts.kubernetesResources.enabled: true
    capabilities:
      apiVersions:
        - monitoring.coreos.com/v1
    asserts:
      - hasDocuments:
          count: 0
