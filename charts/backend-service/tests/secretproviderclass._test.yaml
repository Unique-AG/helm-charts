# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Regression Test SecretProviderClass
templates:
  - secretproviderclass.yaml
release:
  name: ut
tests:
  - it: When given a secretsProvider, should always render SecretProviderClass
    set:
      image.tag: pinned-version
      secretsProvider.enabled: true
      secretsProvider.azure.tenantId: 99330c76-81d2-460e-861e-35af8e2a4266
      secretsProvider.azure.workloadIdentity.clientId: test-client-id
      secretsProvider.azure.keyVaults:
        - name: qa-app-common
          secrets:
            - name: AMQP_URL
              key: RABBITMQ-ORANGE-WOLF-URL
    template: secretproviderclass.yaml
    asserts:
      - isKind:
          of: SecretProviderClass

  - it: When given workload identity access, renders parameters correctly
    values:
      - ../ci/secret-provider-class-vm.values.yaml
    template: secretproviderclass.yaml
    asserts:
      - isKind:
          of: SecretProviderClass
      - equal:
          path: spec.parameters.usePodIdentity
          value: "false"
      - equal:
          path: spec.parameters.useVMManagedIdentity
          value: "true"
      - equal:
          path: spec.parameters.userAssignedIdentityID
          value: some-user-assigned-identity-id
      - equal:
          path: spec.parameters.keyvaultName
          value: some-vault

  - it: When given empty clientId, should fail validation
    set:
      image.tag: pinned-version
      secretsProvider.enabled: true
      secretsProvider.azure.tenantId: 99330c76-81d2-460e-861e-35af8e2a4266
      secretsProvider.azure.workloadIdentity.clientId: ""
      secretsProvider.azure.keyVaults:
        - name: test-vault
          secrets:
            - name: test-secret
              key: test-key
    template: secretproviderclass.yaml
    asserts:
      - failedTemplate:
          errorPattern: "secretsProvider.azure.workloadIdentity.clientId is required"
