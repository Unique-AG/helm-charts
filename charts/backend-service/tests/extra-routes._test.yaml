# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test HTTPRoute
templates:
  - extra-routes.yaml
release:
  name: ecj
tests:
  - it: When given two extra routes, should split them correctly (regression)
    values:
      - ../ci/routes-values.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: extra-routes.yaml
    asserts:
      - hasDocuments:
          count: 2

  - it: renders timeouts correctly
    values:
      - ../ci/routes-values.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: extra-routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-extra-route-1
    asserts:
      - equal:
          path: spec.rules[0].timeouts
          value:
            backendRequest: 60s
            request: 60s

  - it: renders timeouts with different request and backendRequest values
    values:
      - ../ci/routes-values.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: extra-routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-extra-route-2
    asserts:
      - equal:
          path: spec.rules[0].timeouts
          value:
            backendRequest: 60s
            request: 120s

  - it: does not render timeouts when not specified
    set:
      extraRoutes:
        no-timeout-route:
          enabled: true
          parentRefs:
            - name: kong
              namespace: kong-system
              group: gateway.networking.k8s.io
              kind: Gateway
          matches:
            - path:
                type: PathPrefix
                value: /no-timeout
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: extra-routes.yaml
    asserts:
      - notExists:
          path: spec.rules[0].timeouts
