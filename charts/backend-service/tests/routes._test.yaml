# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test HTTPRoute
templates:
  - routes.yaml
release:
  name: ecj
tests:
  - it: When given a httpRoute, renders some properties
    values:
      - ../ci/routes-values.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    asserts:
      - isKind:
          of: HTTPRoute

  - it: When given a scoped httpRoute, renders exact and prefix matches correctly including the service name (regression)
    values:
      - ../ci/routes-values.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-scoped
    asserts:
      - isKind:
          of: HTTPRoute
      - equal:
          path: metadata.name
          value: ecj-scoped
      - equal:
          path: metadata.annotations
          value:
            konghq.com/strip-path: "true"
            konghq.com/plugins: unique-route-metrics
      - equal:
          path: metadata.labels
          value:
            app.kubernetes.io/name: ecj
            app.kubernetes.io/instance: ecj
      - equal:
          path: spec.parentRefs
          value:
            - name: kong
              namespace: system
              group: gateway.networking.k8s.io
              kind: Gateway
      - equal:
          path: spec.hostnames
          value:
            - chart-testing-service.example.com
      - equal:
          path: spec.rules
          value:
            - matches:
                - path:
                    type: Exact
                    value: /scoped/ecj/upload
                  method: POST
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplaceFullPath
                      replaceFullPath: /scoped/upload
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 30s
                request: 30s
            - matches:
                - path:
                    type: Exact
                    value: /scoped/ecj/download
                  method: GET
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplaceFullPath
                      replaceFullPath: /scoped/download
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 30s
                request: 30s
            - matches:
                - path:
                    type: PathPrefix
                    value: /scoped/ecj/html-store
                  method: GET
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplacePrefixMatch
                      replacePrefixMatch: /scoped/html-store
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 30s
                request: 30s

  - it: When given a scoped httpRoute and a pathPrefix, renders matches correctly including both path and prefix overrides (regression)
    values:
      - ../ci/routes-values.yaml
    set:
      routes.pathPrefix: /newPathPrefix
      routes.paths.scoped.pathOverride: /newScopedPathOverride
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-scoped
    asserts:
      - isKind:
          of: HTTPRoute
      - equal:
          path: metadata.name
          value: ecj-scoped
      - equal:
          path: metadata.annotations
          value:
            konghq.com/strip-path: "true"
            konghq.com/plugins: unique-route-metrics
      - equal:
          path: metadata.labels
          value:
            app.kubernetes.io/name: ecj
            app.kubernetes.io/instance: ecj
      - equal:
          path: spec.parentRefs
          value:
            - name: kong
              namespace: system
              group: gateway.networking.k8s.io
              kind: Gateway
      - equal:
          path: spec.hostnames
          value:
            - chart-testing-service.example.com
      - equal:
          path: spec.rules
          value:
            - matches:
                - path:
                    type: Exact
                    value: /newScopedPathOverride/newPathPrefix/upload
                  method: POST
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplaceFullPath
                      replaceFullPath: /newScopedPathOverride/upload
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 30s
                request: 30s
            - matches:
                - path:
                    type: Exact
                    value: /newScopedPathOverride/newPathPrefix/download
                  method: GET
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplaceFullPath
                      replaceFullPath: /newScopedPathOverride/download
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 30s
                request: 30s
            - matches:
                - path:
                    type: PathPrefix
                    value: /newScopedPathOverride/newPathPrefix/html-store
                  method: GET
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplacePrefixMatch
                      replacePrefixMatch: /newScopedPathOverride/html-store
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 30s
                request: 30s

  - it: When given a blocked httpRoute and a pathPrefix, does not render two slashes (regression)
    values:
      - ../ci/routes-values.yaml
    set:
      routes.pathPrefix: /
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-block
    asserts:
      - isKind:
          of: HTTPRoute
      - equal:
          path: spec.rules
          value:
            - matches:
                - path:
                    type: PathPrefix
                    value: /metrics
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 60s
                request: 60s
            - matches:
                - path:
                    type: PathPrefix
                    value: /sensitive
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 60s
                request: 60s

  - it: When given a scoped httpRoute and pathPrefix /, does not render double slashes (regression)
    values:
      - ../ci/routes-values.yaml
    set:
      routes.pathPrefix: /
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-scoped
    asserts:
      - isKind:
          of: HTTPRoute
      - equal:
          path: spec.rules
          value:
            - matches:
                - path:
                    type: Exact
                    value: /scoped/upload
                  method: POST
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplaceFullPath
                      replaceFullPath: /scoped/upload
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 30s
                request: 30s
            - matches:
                - path:
                    type: Exact
                    value: /scoped/download
                  method: GET
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplaceFullPath
                      replaceFullPath: /scoped/download
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 30s
                request: 30s
            - matches:
                - path:
                    type: PathPrefix
                    value: /scoped/html-store
                  method: GET
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplacePrefixMatch
                      replacePrefixMatch: /scoped/html-store
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 30s
                request: 30s

  - it: When given a probe httpRoute and pathPrefix /, does not render double slashes (regression)
    values:
      - ../ci/routes-values.yaml
    set:
      routes.pathPrefix: /
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-probe
    asserts:
      - isKind:
          of: HTTPRoute
      - equal:
          path: spec.rules
          value:
            - matches:
                - path:
                    type: Exact
                    value: /probe
              filters:
                - type: URLRewrite
                  urlRewrite:
                    path:
                      type: ReplaceFullPath
                      replaceFullPath: /probe
              backendRefs:
                - name: ecj
                  port: 80
                  kind: Service
              timeouts:
                backendRequest: 5s
                request: 5s

  - it: When given a versioned httpRoute and pathPrefix /, does not render trailing slash (regression)
    values:
      - ../ci/routes-values.yaml
    set:
      routes.pathPrefix: /
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-versioned
    asserts:
      - isKind:
          of: HTTPRoute
      - equal:
          path: spec.rules[0].matches[0].path.value
          value: /public

  - it: renders default route with per-path timeout override
    values:
      - ../ci/routes-values.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-default
    asserts:
      - equal:
          path: spec.rules[0].timeouts
          value:
            backendRequest: 60s
            request: 60s

  - it: renders versioned route with per-path timeout override
    values:
      - ../ci/routes-values.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-versioned
    asserts:
      - equal:
          path: spec.rules[0].timeouts
          value:
            backendRequest: 120s
            request: 120s

  - it: renders scoped route with inherited global timeout
    values:
      - ../ci/routes-values.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-scoped
    asserts:
      - equal:
          path: spec.rules[0].timeouts
          value:
            backendRequest: 30s
            request: 30s

  - it: renders probe route with per-path timeout
    values:
      - ../ci/routes-values.yaml
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-probe
    asserts:
      - equal:
          path: spec.rules[0].timeouts
          value:
            backendRequest: 5s
            request: 5s

  - it: does not render timeouts when not configured
    set:
      routes:
        hostname: test.example.com
        paths:
          default:
            enabled: true
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-default
    asserts:
      - notExists:
          path: spec.rules[0].timeouts

  - it: renders scoped prefix entry with multiple methods as separate match entries
    set:
      routes:
        hostname: test.example.com
        pathPrefix: /
        paths:
          scoped:
            enabled: true
            allowList:
              - path: /data
                type: PathPrefix
                methods:
                  - GET
                  - POST
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-scoped
    asserts:
      - equal:
          path: spec.rules[0].matches
          value:
            - path:
                type: PathPrefix
                value: /scoped/data
              method: GET
            - path:
                type: PathPrefix
                value: /scoped/data
              method: POST
      - equal:
          path: spec.rules[0].filters[0].urlRewrite.path
          value:
            type: ReplacePrefixMatch
            replacePrefixMatch: /scoped/data

  - it: renders mixed scoped allowList with exact and prefix entries
    set:
      routes:
        hostname: test.example.com
        pathPrefix: /
        paths:
          scoped:
            enabled: true
            allowList:
              - path: /upload
              - path: /html-store
                type: PathPrefix
                methods:
                  - GET
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-scoped
    asserts:
      - equal:
          path: spec.rules[0].matches[0].path.type
          value: Exact
      - equal:
          path: spec.rules[0].matches[0].method
          value: GET
      - equal:
          path: spec.rules[0].filters[0].urlRewrite.path.type
          value: ReplaceFullPath
      - equal:
          path: spec.rules[1].matches[0].path.type
          value: PathPrefix
      - equal:
          path: spec.rules[1].matches[0].method
          value: GET
      - equal:
          path: spec.rules[1].filters[0].urlRewrite.path.type
          value: ReplacePrefixMatch

  - it: renders object entry with default type and default method
    set:
      routes:
        hostname: test.example.com
        pathPrefix: /
        paths:
          scoped:
            enabled: true
            allowList:
              - path: /upload
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-scoped
    asserts:
      - equal:
          path: spec.rules[0].matches[0].path.type
          value: Exact
      - equal:
          path: spec.rules[0].matches[0].method
          value: GET
      - equal:
          path: spec.rules[0].filters[0].urlRewrite.path.type
          value: ReplaceFullPath

  - it: renders object entry with explicit type Exact and methods
    set:
      routes:
        hostname: test.example.com
        pathPrefix: /
        paths:
          scoped:
            enabled: true
            allowList:
              - path: /upload
                type: Exact
                methods:
                  - POST
    capabilities:
      apiVersions:
        - gateway.networking.k8s.io/v1
    template: routes.yaml
    documentSelector:
      path: metadata.name
      value: ecj-scoped
    asserts:
      - equal:
          path: spec.rules[0].matches[0].path.type
          value: Exact
      - equal:
          path: spec.rules[0].matches[0].method
          value: POST
      - equal:
          path: spec.rules[0].filters[0].urlRewrite.path.type
          value: ReplaceFullPath
