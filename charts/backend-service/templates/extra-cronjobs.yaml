{{- $fullName := include "backend-service.fullname" . -}}
{{- $labels := include "backend-service.labels" . -}}
{{- $globalValues := .Values -}}
{{- range $key, $value := .Values.extraCronJobs -}}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $fullName }}-{{ $key }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: cron-job-{{ $key }}
spec:
  {{- if $value.schedule }}
  schedule: {{ $value.schedule | quote }}
  {{- else }}
  {{- fail (printf "extraCronJob '%s' 'schedule' is not defined" $key) }}
  {{- end }}
  suspend: {{ $value.suspend | default false }}
  timeZone: {{ $value.timeZone | default "Europe/Zurich" | quote }}
  concurrencyPolicy: {{ $value.concurrencyPolicy | default "Forbid" | quote }}
  successfulJobsHistoryLimit: {{ $value.successfulJobsHistoryLimit | default 3 }}
  failedJobsHistoryLimit: {{ $value.failedJobsHistoryLimit | default 3 }}
  startingDeadlineSeconds: {{ $value.startingDeadlineSeconds | default 10 }}
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- if $.Values.podLabels }}
              {{- with $.Values.podLabels }}
                {{- toYaml . | nindent 12 }}
              {{- end }}
            {{- end }}
            {{- $labels | nindent 12 }}
            app.kubernetes.io/component: cron-job-{{ $key }}
          annotations:
            {{- if $.Values.podAnnotations }}
              {{- with $.Values.podAnnotations }}
                {{- toYaml . | nindent 12 }}
              {{- end }}
            {{- end }}
            {{- if $globalValues.envSecrets }}
            checksum/secrets: {{ include (print $.Template.BasePath "/secret-env.yaml") . | sha256sum }}
            {{- end }}
        spec:
          {{- with $globalValues.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          restartPolicy: {{ $value.restartPolicy | default "Never" | quote }}
          containers:
            - name: {{ $key }}
              image: "{{ $globalValues.image.repository }}:{{ $globalValues.image.tag }}"
              imagePullPolicy: {{ $globalValues.image.pullPolicy }}
              securityContext: {{- toYaml $globalValues.securityContext | nindent 16 }}
              resources:
                {{- toYaml $globalValues.resources | nindent 16 }}
              volumeMounts:
              {{- with $globalValues.volumeMounts }}
                {{- toYaml . | nindent 16 }}
              {{- end }}
              {{- if and $globalValues.secretsProvider.enabled (eq $globalValues.secretsProvider.provider "azure") }}
              {{- range $globalValues.secretsProvider.azure.keyVaults }}
                - name: secrets-store-{{ .name }}
                  mountPath: /mnt/secrets-store/{{ .name }}
                  readOnly: true
              {{- end }}
              {{- end }}
              envFrom:
                {{- if $globalValues.env }}
                - configMapRef:
                    name: {{ $fullName }}-env
                {{- end }}
                {{- if $globalValues.envSecrets }}
                - secretRef:
                    name: {{ $fullName }}-secrets
                {{- end }}
                {{- range $globalValues.extraEnvConfigMaps }}
                - configMapRef:
                    name: {{ . }}
                {{- end }}
                {{- range $globalValues.extraEnvSecrets }}
                - secretRef:
                    name: {{ . }}
                {{- end }}
              env:
                - name: VERSION
                  value: {{ $globalValues.image.tag | quote}}
                {{- with $globalValues.envVars }}
                  {{- toYaml . | nindent 16 }}
                {{- end }}
                {{- /* local envVars will take precedence over global envVars as they are specified last */}}
                {{- with .envVars }}
                  {{- toYaml . | nindent 16 }}
                {{- end }}
                {{- if and $globalValues.secretsProvider.enabled (eq $globalValues.secretsProvider.provider "azure") }}
                {{- range $globalValues.secretsProvider.azure.keyVaults }}
                {{- range .secrets }}
                - name: {{ .name }}
                  valueFrom:
                    secretKeyRef:
                      name: {{ $fullName }}-{{ $.name }}
                      key: {{ .key }}
                {{- end }}
                {{- end }}
                {{- end }}
          {{- with $globalValues.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $globalValues.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $globalValues.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumes:
          {{- with $globalValues.volumes }}
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if and $globalValues.secretsProvider.enabled (eq $globalValues.secretsProvider.provider "azure") }}
          {{- range $globalValues.secretsProvider.azure.keyVaults }}
            - name: secrets-store-{{ .name }}
              csi:
                driver: secrets-store.csi.k8s.io
                readOnly: true
                volumeAttributes:
                  secretProviderClass: {{ $fullName }}-{{ .name }}
          {{- end }}
          {{- end }}
{{- end }}
