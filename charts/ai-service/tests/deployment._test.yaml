# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Regression Test Deployment
templates:
  - deployment-env.yaml
  - deployment.yaml
release:
  name: ut
tests:
  - it: When given a secretProvider, should always render volumeMounts and volumes for them
    set:
      image.tag: pinned-version
      secretProvider.tenantId: 99330c76-81d2-460e-861e-35af8e2a4266
      secretProvider.userAssignedIdentityID: test-identity-id
      secretProvider.vaults.qa-app-common.AMQP_URL: RABBITMQ-ORANGE-WOLF-URL
    template: deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - isNotNullOrEmpty:
          path: spec.template.spec.volumes[?(@.name == "ut-qa-app-common")]
      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "ut")].volumeMounts[?(@.name == "ut-qa-app-common")]

  - it: When given a secretProvider with VM Managed Identity, should render correctly
    set:
      image.tag: pinned-version
      secretProvider.tenantId: 99330c76-81d2-460e-861e-35af8e2a4266
      secretProvider.userAssignedIdentityID: test-identity-id
      secretProvider.vaults.qa-app-common.AMQP_URL: RABBITMQ-ORANGE-WOLF-URL
    template: deployment.yaml
    asserts:
      - notExists:
          path: spec.template.metadata.labels.aadpodidbinding

  - it: When given an initContainer, should always render volumeMounts and volumes for them
    set:
      deployment.initContainers[0]:
        volumeMounts:
          - name: data
            mountPath: /opt
            mountPathDeployment: /opt/folder
            readOnly: true
            emptyDir: true
        command:
          - "sh"
          - "-e"
          - "echo"
          - "helloWorld"
    template: deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - isNotNullOrEmpty:
          path: spec.template.spec.initContainers[0]
      - isNotNullOrEmpty:
          path: spec.template.spec.initContainers[?(@.name == "init-ut")]
      - isNotNullOrEmpty:
          path: spec.template.spec.volumes[?(@.name == "data")]
      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "ut")].volumeMounts[?(@.name == "data")]
      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "ut")].volumeMounts[?(@.mountPath == "/opt/folder")]
      - isNotNullOrEmpty:
          path: spec.template.spec.containers[?(@.name == "ut")].volumeMounts[?(@.readOnly == true)]
      - isNotNullOrEmpty:
          path: spec.template.spec.volumes[?(@.name == "data")]

  - it: When given pod labels and annotations, should render them correctly
    set:
      image.tag: pinned-version
      podLabels:
        app: test-app
        environment: testing
        custom.label/key: custom-value
      podAnnotations:
        example.com/annotation: test-value
        prometheus.io/scrape: "true"
        prometheus.io/port: "8081"
    template: deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.metadata.labels.app
          value: test-app
      - equal:
          path: spec.template.metadata.labels.environment
          value: testing
      - equal:
          path: spec.template.metadata.labels["custom.label/key"]
          value: custom-value
      - equal:
          path: spec.template.metadata.annotations["example.com/annotation"]
          value: test-value
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: "8081"

  - it: When no extra pod labels or annotations are given, should only have default labels
    set:
      image.tag: pinned-version
    template: deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - isNotNullOrEmpty:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: ut
      - isNotNullOrEmpty:
          path: spec.template.metadata.annotations.checksum/deployment-env

  - it: When using CI values with pod labels and annotations, should render all values correctly
    values:
      - ../ci/pod-annotations-labels-values.yaml
    template: deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.metadata.labels.app
          value: test-application
      - equal:
          path: spec.template.metadata.labels.environment
          value: ci-testing
      - equal:
          path: spec.template.metadata.labels.version
          value: v1.0.0
      - equal:
          path: spec.template.metadata.labels.team
          value: platform
      - equal:
          path: spec.template.metadata.labels["custom.domain/label"]
          value: custom-value
      - equal:
          path: spec.template.metadata.labels["kubernetes.io/managed-by"]
          value: helm
      - equal:
          path: spec.template.metadata.annotations["example.com/annotation"]
          value: test-annotation-value
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: "8081"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/path"]
          value: "/metrics"
      - equal:
          path: spec.template.metadata.annotations["fluentd.org/exclude"]
          value: "false"
      - equal:
          path: spec.template.metadata.annotations["custom.domain/annotation"]
          value: custom-annotation-value
      - equal:
          path: spec.template.metadata.annotations["deployment.kubernetes.io/revision"]
          value: "1"
